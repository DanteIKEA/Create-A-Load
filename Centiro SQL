with Stop1 as
(
  select distinct 
##shipment main table
q1.shipment_id_nbr,q1.current_event_code, 

##tsp
shipment.loading_unit_id,shipment.transport_service_provider.name,
##nested location data
locations_bu_skey,location_type,location_time.originally_planned, location_time.estimated,sequence_of_location,business_unit_code,business_unit_type,seal_no from `ingka-ofd-solutiondata-prod.pz_centiro_trunkline_no_pii.cent_trnkl_shipment_fcv` q1,unnest(shipment.locations)
inner join (select shipment_id_nbr,max(bq_upd_dtm) as maxdt
from `ingka-ofd-solutiondata-prod.pz_centiro_trunkline_no_pii.cent_trnkl_shipment_fcv` 
group by shipment_id_nbr) q2
on q1.bq_upd_dtm=q2.maxdt
and q1.shipment_id_nbr=q2.shipment_id_nbr

where q1.shipment_id_nbr='CTS100003209'
and sequence_of_location=1
),

Stop2 as 
(
select distinct
  ##shipment main table
q1.shipment_id_nbr,q1.current_event_code, 

##tsp
shipment.loading_unit_id,shipment.transport_service_provider.name,
##nested location data
locations_bu_skey,location_type,location_time.originally_planned, location_time.estimated,sequence_of_location,business_unit_code,business_unit_type,seal_no from `ingka-ofd-solutiondata-prod.pz_centiro_trunkline_no_pii.cent_trnkl_shipment_fcv` q1,unnest(shipment.locations)

inner join (select shipment_id_nbr,max(bq_upd_dtm) as maxdt
from `ingka-ofd-solutiondata-prod.pz_centiro_trunkline_no_pii.cent_trnkl_shipment_fcv` 
group by shipment_id_nbr) q2
on q1.bq_upd_dtm=q2.maxdt
and q1.shipment_id_nbr=q2.shipment_id_nbr

inner join (select q1.shipment_id_nbr, max(sequence_of_location) as sequence
from `ingka-ofd-solutiondata-prod.pz_centiro_trunkline_no_pii.cent_trnkl_shipment_fcv` q1,unnest(shipment.locations)
 group by shipment_id_nbr) q3
 on sequence_of_location=q3.sequence
 and q1.shipment_id_nbr=q3.shipment_id_nbr

where q1.shipment_id_nbr='CTS100003209'

)

Select * from Stop2
